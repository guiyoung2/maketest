!function(t,s){"function"==typeof define&&define.amd?define(["raphael"],function(a){return s(a||t.Raphael)}):s(Raphael)}(this,function(t){t.fn.freeTransform=function(t,s,a){function e(t){("set"===t.type?t.items:[t]).map(function(t){"set"===t.type?e(t):p.items.push({el:t,attrs:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},transformString:t.matrix.toTransformString()})})}function r(t){var s,a,e=[],r=[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}];return"number"!=typeof t&&(t=0),s={x:p.attrs.rotate*Math.PI/180,y:(p.attrs.rotate+90)*Math.PI/180},a={x:p.attrs.size.x/2*p.attrs.scale.x+t,y:p.attrs.size.y/2*p.attrs.scale.y+t},r.map(function(t){e.push({x:p.attrs.center.x+p.attrs.translate.x+t.x*a.x*Math.cos(s.x)+t.y*a.y*Math.cos(s.y),y:p.attrs.center.y+p.attrs.translate.y+t.x*a.x*Math.sin(s.x)+t.y*a.y*Math.sin(s.y)})}),e}function o(){var t={x:/^([0-9]+)%$/.exec(h.width),y:/^([0-9]+)%$/.exec(h.height)};return{x:t.x?h.canvas.clientWidth||h.canvas.parentNode.clientWidth*parseInt(t.x[1],10)*.01:h.canvas.clientWidth||h.width,y:t.y?h.canvas.clientHeight||h.canvas.parentNode.clientHeight*parseInt(t.y[1],10)*.01:h.canvas.clientHeight||h.height}}function n(t){var s,a,e,r={x:0,y:0},n={x:0,y:0};t&&p.opts.snap.drag&&(s=t.x,a=t.y,[0,1].map(function(){r.x=s-Math.round(s/p.opts.snap.drag)*p.opts.snap.drag,r.y=a-Math.round(a/p.opts.snap.drag)*p.opts.snap.drag,Math.abs(r.x)<=p.opts.snapDist.drag&&(n.x=r.x),Math.abs(r.y)<=p.opts.snapDist.drag&&(n.y=r.y),s+=t.width-n.x,a+=t.height-n.y}),p.attrs.translate.x-=n.x,p.attrs.translate.y-=n.y),p.opts.boundary&&(p.opts.boundarywidth=p.opts.boundarywidth||o().x*(p.o.viewBoxRatio&&p.o.viewBoxRatio.x||1),p.opts.boundaryheight=p.opts.boundaryheight||o().y*(p.o.viewBoxRatio&&p.o.viewBoxRatio.y||1),p.attrs.center.x+p.attrs.translate.x<p.opts.boundary.x&&(p.attrs.translate.x+=p.opts.boundary.x-(p.attrs.center.x+p.attrs.translate.x)),p.attrs.center.y+p.attrs.translate.y<p.opts.boundary&&(p.attrs.translate.y+=p.opts.boundary-(p.attrs.center.y+p.attrs.translate.y)),p.attrs.center.x+p.attrs.translate.x>p.opts.boundary.x+p.opts.boundarywidth&&(p.attrs.translate.x+=p.opts.boundary.x+p.opts.boundarywidth-(p.attrs.center.x+p.attrs.translate.x)),p.attrs.center.y+p.attrs.translate.y>p.opts.boundary+p.opts.boundaryheight&&(p.attrs.translate.y+=p.opts.boundary+p.opts.boundaryheight-(p.attrs.center.y+p.attrs.translate.y))),r=Math.abs(p.attrs.rotate%p.opts.snap.rotate),r=Math.min(r,p.opts.snap.rotate-r),r<p.opts.snapDist.rotate&&(p.attrs.rotate=Math.round(p.attrs.rotate/p.opts.snap.rotate)*p.opts.snap.rotate),r={x:Math.abs(p.attrs.scale.x*p.attrs.size.x%p.opts.snap.scale),y:Math.abs(p.attrs.scale.y*p.attrs.size.x%p.opts.snap.scale)},r={x:Math.min(r.x,p.opts.snap.scale-r.x),y:Math.min(r.y,p.opts.snap.scale-r.y)},r.x<p.opts.snapDist.scale&&(p.attrs.scale.x=Math.round(p.attrs.scale.x*p.attrs.size.x/p.opts.snap.scale)*p.opts.snap.scale/p.attrs.size.x),r.y<p.opts.snapDist.scale&&(p.attrs.scale.y=Math.round(p.attrs.scale.y*p.attrs.size.y/p.opts.snap.scale)*p.opts.snap.scale/p.attrs.size.y),p.opts.range.rotate&&(e=(360+p.attrs.rotate)%360,e>180&&(e-=360),e<p.opts.range.rotate[0]&&(p.attrs.rotate+=p.opts.range.rotate[0]-e),e>p.opts.range.rotate[1]&&(p.attrs.rotate+=p.opts.range.rotate[1]-e)),p.opts.range.scale&&(p.attrs.scale.x*p.attrs.size.x<p.opts.range.scale[0]&&(p.attrs.scale.x=p.opts.range.scale[0]/p.attrs.size.x),p.attrs.scale.y*p.attrs.size.y<p.opts.range.scale[0]&&(p.attrs.scale.y=p.opts.range.scale[0]/p.attrs.size.y),p.attrs.scale.x*p.attrs.size.x>p.opts.range.scale[1]&&(p.attrs.scale.x=p.opts.range.scale[1]/p.attrs.size.x),p.attrs.scale.y*p.attrs.size.y>p.opts.range.scale[1]&&(p.attrs.scale.y=p.opts.range.scale[1]/p.attrs.size.y))}function i(){return{x:p.attrs.scale.x*p.attrs.size.x>=p.opts.range.scale[0]&&p.attrs.scale.x*p.attrs.size.x<=p.opts.range.scale[1],y:p.attrs.scale.y*p.attrs.size.y>=p.opts.range.scale[0]&&p.attrs.scale.y*p.attrs.size.y<=p.opts.range.scale[1]}}function c(t){"x"===t?p.attrs.scale.y=p.attrs.scale.x/p.attrs.ratio:p.attrs.scale.x=p.attrs.scale.y*p.attrs.ratio}function l(t){var s,a={};for(s in t)a[s]="object"==typeof t[s]?l(t[s]):t[s];return a}function x(t){var s=[];p.callback&&(t.map(function(t,a){t&&s.push(t)}),clearTimeout(u),u=setTimeout(function(){p.callback&&p.callback(p,s,r())},.1))}var p,y,d,u,h=this,f=t.getBBox(!0);return t.freeTransform?t.freeTransform:(Array.prototype.hasOwnProperty("map")||(Array.prototype.map=function(t,s){d=[];for(y in this)this.hasOwnProperty(y)&&(d[y]=t.call(s,this[y],y,this));return d}),Array.prototype.hasOwnProperty("indexOf")||(Array.prototype.indexOf=function(t,s){for(y=s||0,j=this.length;y<j;y++)if(this[y]===t)return y;return-1}),p=t.freeTransform={attrs:{x:f.x,y:f.y,size:{x:f.width,y:f.height},center:{x:f.x+f.width/2,y:f.y+f.height/2},rotate:0,scale:{x:1,y:1},translate:{x:0,y:0},ratio:1},axes:null,bbox:null,callback:null,items:[],handles:{center:null,x:null,y:null},offset:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},opts:{animate:!1,attrs:{fill:"#fff",stroke:"#000"},boundary:{x:h._left||0,y:h._top||0,width:null,height:null},customCorners:!1,distance:1.3,drag:!0,draw:!1,keepRatio:!1,range:{rotate:[-180,180],scale:[-99999,99999]},rotate:!0,scale:!0,snap:{rotate:0,scale:0,drag:0},snapDist:{rotate:0,scale:0,drag:7},size:5},subject:t},p.updateHandles=function(){var t,s,a,e,n,i,c,l=[[-1,-1],[1,-1],[1,1],[-1,1],[0,-1],[1,0],[0,1],[-1,0]];return(p.handles.bbox||p.opts.rotate.indexOf("self")>=0)&&(s=t=r(0),p.opts.customCorners&&"number"==typeof p.opts.customCorners.distance&&(s=r(p.opts.customCorners.distance))),a={x:p.attrs.rotate*Math.PI/180,y:(p.attrs.rotate+90)*Math.PI/180},e={x:p.attrs.size.x/2*p.attrs.scale.x,y:p.attrs.size.y/2*p.attrs.scale.y},p.axes.map(function(t){p.handles[t]&&(n=p.attrs.center.x+p.attrs.translate.x+e[t]*p.opts.distance*Math.cos(a[t]),i=p.attrs.center.y+p.attrs.translate.y+e[t]*p.opts.distance*Math.sin(a[t]),c={x:1,y:1},h._viewBox&&(c={x:h._viewBox[2]/o().x,y:h._viewBox[3]/o().y}),p.opts.boundary&&(n=Math.max(Math.min(n,p.opts.boundary.x+(p.opts.boundary.width||o().x*c.x)),p.opts.boundary.x),i=Math.max(Math.min(i,p.opts.boundary.y+(p.opts.boundary.height||o().y*c.y)),p.opts.boundary.y)),p.handles[t].disc.attr({cx:n,cy:i}),p.handles[t].line.toFront().attr({path:[["M",p.attrs.center.x+p.attrs.translate.x,p.attrs.center.y+p.attrs.translate.y],["L",p.handles[t].disc.attrs.cx,p.handles[t].disc.attrs.cy]]}),p.handles[t].disc.toFront())}),p.bbox&&(p.bbox.toFront().attr({path:[["M",t[0].x,t[0].y],["L",t[1].x,t[1].y],["L",t[2].x,t[2].y],["L",t[3].x,t[3].y],["L",t[0].x,t[0].y]]}),p.handles.bbox&&p.handles.bbox.map(function(a,e){var r,o,n,i;a.isCorner?(r=s[e].x,o=s[e].y):(n=e%4,i=(n+1)%t.length,r=(s[n].x+s[i].x)/2,o=(s[n].y+s[i].y)/2),a.element.toFront().attr({x:r-(a.isCorner?p.opts.customCorners?Math.ceil(p.opts.customCorners.size/2):p.opts.size.bboxCorners:p.opts.size.bboxSides),y:o-(a.isCorner?p.opts.customCorners?Math.ceil(p.opts.customCorners.size/2):p.opts.size.bboxCorners:p.opts.size.bboxSides)}).transform(p.opts.customCorners?null:"R"+p.attrs.rotate),a.x=l[e][0],a.y=l[e][1]})),p.circle&&p.circle.attr({cx:p.attrs.center.x+p.attrs.translate.x,cy:p.attrs.center.y+p.attrs.translate.y,r:Math.max(e.x,e.y)*p.opts.distance}),p.handles.center&&p.handles.center.disc.toFront().attr({cx:p.attrs.center.x+p.attrs.translate.x,cy:p.attrs.center.y+p.attrs.translate.y}),p.opts.rotate.indexOf("self")>=0&&(e=Math.max(Math.sqrt(Math.pow(t[1].x-t[0].x,2)+Math.pow(t[1].y-t[0].y,2)),Math.sqrt(Math.pow(t[2].x-t[1].x,2)+Math.pow(t[2].y-t[1].y,2)))/2),p},p.showHandles=function(){var s,a,e,r,y=[];if(draggables=[],p.hideHandles(),p.axes.map(function(t){p.handles[t]={},p.handles[t].line=h.path(["M",p.attrs.center.x,p.attrs.center.y]).attr({stroke:p.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:.5}),p.handles[t].disc=h.circle(p.attrs.center.x,p.attrs.center.y,p.opts.size.axes).attr(p.opts.attrs),p.handles[t].disc.node.setAttribute("class","handle arm axis-"+t)}),p.opts.draw.indexOf("bbox")>=0)for(p.bbox=h.path("").attr({stroke:p.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:.5}),p.handles.bbox=[],s=p.opts.scale.indexOf("bboxCorners")||p.opts.customCorners>=0?0:4;s<(-1===p.opts.scale.indexOf("bboxSides")?4:8);s++)a={},a.index=s,a.axis=s%2?"x":"y",a.isCorner=4>s,a.isCorner&&p.opts.customCorners?a.element=h.image(p.opts.customCorners.corners[s].image,p.attrs.center.x,p.attrs.center.y,p.opts.customCorners.size,p.opts.customCorners.size):(a.element=h.rect(p.attrs.center.x,p.attrs.center.y,2*p.opts.size[a.isCorner?"bboxCorners":"bboxSides"],2*p.opts.size[a.isCorner?"bboxCorners":"bboxSides"]).attr(p.opts.attrs),a.isCorner?a.element.node.setAttribute("class","handle bbox corner index-"+s+" axis-"+a.axis):a.element.node.setAttribute("class","handle bbox side index-"+(s-4)+" axis-"+a.axis)),p.handles.bbox[s]=a;return-1!==p.opts.draw.indexOf("circle")&&(p.circle=h.circle(0,0,0).attr({stroke:p.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:.3})),-1!==p.opts.drag.indexOf("center")&&(p.handles.center={},p.handles.center.disc=h.circle(p.attrs.center.x,p.attrs.center.y,p.opts.size.center).attr(p.opts.attrs),p.handles.center.disc.node.setAttribute("class","handle center")),p.axes.map(function(t){p.handles[t]&&y.push({element:p.handles[t].disc,rotate:-1!==p.opts.rotate.indexOf("axis"+t.toUpperCase()),scale:-1!==p.opts.scale.indexOf("axis"+t.toUpperCase()),axis:t,isCorner:!1})}),p.opts.customCorners&&p.handles.bbox.map(function(t){var s;"undefined"!=typeof p.opts.customCorners.corners[t.index]&&(s=p.opts.customCorners.corners[t.index].action,("rotate"===s||"scale"===s)&&y.push({element:t.element,rotate:"rotate"===s,scale:"scale"===s,axis:"x",isCorner:!0}))}),y.map(function(t){t.element.drag(function(s,a){var e,r,i,l,y,d,u={x:p.o.scale.x<0,y:p.o.scale.y<0};p.o.viewBoxRatio&&(s*=p.o.viewBoxRatio.x,a*=p.o.viewBoxRatio.y),e=s+t.element.ox,r=a+t.element.oy,t.rotate&&(i=Math.atan2(r-p.o.center.y-p.o.translate.y,e-p.o.center.x-p.o.translate.x),p.attrs.rotate=180*i/Math.PI-p.o.angle,u[t.axis]&&(p.attrs.rotate-=180)),p.opts.boundary&&(e=Math.max(Math.min(e,p.opts.boundary.x+(p.opts.boundary.width||o().x*(p.o.viewBoxRatio&&p.o.viewBoxRatio.x||1))),p.opts.boundary.x),r=Math.max(Math.min(r,p.opts.boundary.y+(p.opts.boundary.height||o().y*(p.o.viewBoxRatio&&p.o.viewBoxRatio.y||1))),p.opts.boundary.y)),l=e-p.o.center.x-p.o.translate.x-(p.opts.customCorners?p.opts.customCorners.distance:0),y=r-p.o.center.y-p.o.translate.y-(p.opts.customCorners?p.opts.customCorners.distance:0),d=Math.sqrt(Math.pow(l,2)+Math.pow(y,2)),t.scale&&(p.attrs.scale[t.axis]=d/(p.o.size[t.axis]/2*p.o.distance),u[t.axis]&&(p.attrs.scale[t.axis]*=-1)),n(),-1!==p.opts.keepRatio.indexOf("axis"+t.axis.toUpperCase())?c(t.axis):p.attrs.ratio=p.attrs.scale.x/p.attrs.scale.y,p.attrs.scale.x&&p.attrs.scale.y&&p.apply(),x([t.rotate?"rotate":null,t.scale?"scale":null])},function(){p.o=l(p.attrs),h._viewBox&&(p.o.viewBoxRatio={x:h._viewBox[2]/o().x,y:h._viewBox[3]/o().y}),t.element.ox=this.attrs.cx?this.attrs.cx:this.attrs.x+this.attrs.width/2,t.element.oy=this.attrs.cy?this.attrs.cy:this.attrs.y+this.attrs.height/2,t.isCorner?(hypotenuse=Math.sqrt(Math.pow(p.o.size.x*p.o.scale.x,2)+Math.pow(p.o.size.y*p.o.scale.y,2))/2,opposite=p.o.size.x*p.o.scale.x/2,pos={x:t.element.ox-(p.o.center.x+p.o.x+p.o.translate.x),y:t.element.oy-(p.o.center.y+p.o.y+p.o.translate.y)},p.o.distance=hypotenuse/opposite,p.o.angle=90-180*Math.atan2(pos.x,pos.y)/Math.PI-p.o.rotate):(p.o.distance=p.opts.distance,p.o.angle="y"===t.axis?90:0),x([t.rotate?"rotate start":null,t.scale?"scale start":null])},function(){x([t.rotate?"rotate end":null,t.scale?"scale end":null])})}),p.opts.draw.indexOf("bbox")>=0&&!p.opts.customCorners&&(-1!==p.opts.scale.indexOf("bboxCorners")||-1!==p.opts.scale.indexOf("bboxSides"))&&p.handles.bbox.map(function(t){t.element.drag(function(s,a){var e,r,o,y,d,u,h,f,b,m,g,w,v,M=l(p.attrs),C={x:0,y:0};p.o.viewBoxRatio&&(s*=p.o.viewBoxRatio.x,a*=p.o.viewBoxRatio.y),e=p.o.rotate.sin,r=p.o.rotate.cos,o=s*r-a*e,y=s*e+a*r,o*=Math.abs(t.x),y*=Math.abs(t.y),d=o*r+y*e,u=o*-e+y*r,p.attrs.translate={x:p.o.translate.x+d/2,y:p.o.translate.y+u/2},h=p.o.handlePos.cx+s-p.attrs.center.x-p.attrs.translate.x,f=p.o.handlePos.cy+a-p.attrs.center.y-p.attrs.translate.y,o=h*r-f*e,y=h*e+f*r,t.isCorner&&-1!==p.opts.keepRatio.indexOf("bboxCorners")&&(g=p.attrs.size.x*p.attrs.scale.x/(p.attrs.size.y*p.attrs.scale.y),w=o*t.x*(1/g),v=y*t.y*g,v>w*g?o=v*t.x:y=w*t.y),b=2*o*t.x/p.o.size.x,m=2*y*t.y/p.o.size.y,p.attrs.scale={x:b||p.attrs.scale.x,y:m||p.attrs.scale.y},i().x&&i().y||(p.attrs=M),n(),(t.isCorner&&-1!==p.opts.keepRatio.indexOf("bboxCorners")||!t.isCorner&&-1!==p.opts.keepRatio.indexOf("bboxSides"))&&(c(t.axis),C.x=(p.attrs.scale.x-p.o.scale.x)*p.o.size.x*t.x,C.y=(p.attrs.scale.y-p.o.scale.y)*p.o.size.y*t.y,o=C.x*r+C.y*e,y=-C.x*e+C.y*r,p.attrs.translate.x=p.o.translate.x+o/2,p.attrs.translate.y=p.o.translate.y+y/2),p.attrs.ratio=p.attrs.scale.x/p.attrs.scale.y,x(["scale"]),p.apply()},function(){var s=(360-p.attrs.rotate)%360/180*Math.PI,a=t.element.attr(["x","y"]);p.o=l(p.attrs),p.o.handlePos={cx:a.x+p.opts.size[t.isCorner?"bboxCorners":"bboxSides"],cy:a.y+p.opts.size[t.isCorner?"bboxCorners":"bboxSides"]},p.o.rotate={sin:Math.sin(s),cos:Math.cos(s)},h._viewBox&&(p.o.viewBoxRatio={x:h._viewBox[2]/o().x,y:h._viewBox[3]/o().y}),x(["scale start"])},function(){x(["scale end"])})}),p.opts.customCorners&&p.handles.bbox.map(function(t){"undefined"!=typeof p.opts.customCorners.corners[t.index]&&-1===["drag","rotate","scale"].indexOf(p.opts.customCorners.corners[t.index].action)&&(t.element.drag(function(){return!1}),t.element.click(function(){x(["custom:"+p.opts.customCorners.corners[t.index].action])}))}),p.opts.drag.indexOf("self")>=0&&-1===p.opts.scale.indexOf("self")&&-1===p.opts.rotate.indexOf("self")&&draggables.push(t),p.opts.drag.indexOf("center")>=0&&draggables.push(p.handles.center.disc),p.opts.customCorners&&p.handles.bbox.map(function(t){"undefined"!=typeof p.opts.customCorners.corners[t.index]&&"drag"===p.opts.customCorners.corners[t.index].action&&draggables.push(t.element)}),draggables.map(function(s){s.drag(function(t,s){var a=l(p.o.bbox);p.o.viewBoxRatio&&(t*=p.o.viewBoxRatio.x,s*=p.o.viewBoxRatio.y),p.attrs.translate.x=p.o.translate.x+t,p.attrs.translate.y=p.o.translate.y+s,a.x+=t,a.y+=s,n(a),x(["drag"]),p.apply()},function(){p.o=l(p.attrs),p.opts.snap.drag&&(p.o.bbox=t.getBBox()),h._viewBox&&(p.o.viewBoxRatio={x:h._viewBox[2]/o().x,y:h._viewBox[3]/o().y}),p.axes.map(function(t){p.handles[t]&&(p.handles[t].disc.ox=p.handles[t].disc.attrs.cx,p.handles[t].disc.oy=p.handles[t].disc.attrs.cy)}),x(["drag start"])},function(){x(["drag end"])})}),e=p.opts.rotate.indexOf("self")>=0,r=p.opts.scale.indexOf("self")>=0,(e||r)&&t.drag(function(t,s,a,o){var i,c,l={x:p.o.scale.x<0,y:p.o.scale.y<0};e&&(i=Math.atan2(o-p.o.center.y-p.o.translate.y,a-p.o.center.x-p.o.translate.x),p.attrs.rotate=p.o.rotate+180*i/Math.PI-p.o.deg),r&&(c=Math.sqrt(Math.pow(a-p.o.center.x-p.o.translate.x,2)+Math.pow(o-p.o.center.y-p.o.translate.y,2)),p.attrs.scale.x=p.attrs.scale.y=(l.x?-1:1)*p.o.scale.x+(c-p.o.radius)/(p.o.size.x/2),l.x&&(p.attrs.scale.x*=-1),l.y&&(p.attrs.scale.y*=-1)),n(),p.apply(),x([e?"rotate":null,r?"scale":null])},function(t,s){p.o=l(p.attrs),p.o.deg=180*Math.atan2(s-p.o.center.y-p.o.translate.y,t-p.o.center.x-p.o.translate.x)/Math.PI,p.o.radius=Math.sqrt(Math.pow(t-p.o.center.x-p.o.translate.x,2)+Math.pow(s-p.o.center.y-p.o.translate.y,2)),h._viewBox&&(p.o.viewBoxRatio={x:h._viewBox[2]/o().x,y:h._viewBox[3]/o().y}),x([e?"rotate start":null,r?"scale start":null])},function(){x([e?"rotate end":null,r?"scale end":null])}),p.updateHandles(),p},p.hideHandles=function(t){var t=t||{};return void 0===t.undrag&&(t.undrag=!0),t.undrag&&p.items.map(function(t){t.el.undrag()}),p.handles.center&&(p.handles.center.disc.remove(),p.handles.center=null),["x","y"].map(function(t){p.handles[t]&&(p.handles[t].disc.remove(),p.handles[t].line.remove(),p.handles[t]=null)}),p.bbox&&(p.bbox.remove(),p.bbox=null,p.handles.bbox&&(p.handles.bbox.map(function(t){t.element.remove()}),p.handles.bbox=null)),p.circle&&(p.circle.remove(),p.circle=null),p},p.setOpts=function(t,s){var a,e;void 0!==s&&(p.callback="function"==typeof s?s:!1);for(a in t)if(t[a]&&t[a].constructor===Object){p.opts[a]===!1&&(p.opts[a]={});for(e in t[a])t[a].hasOwnProperty(e)&&(p.opts[a][e]=t[a][e])}else p.opts[a]=t[a];return p.opts.animate===!0&&(p.opts.animate={delay:700,easing:"linear"}),p.opts.drag===!0&&(p.opts.drag=["center","self"]),p.opts.keepRatio===!0&&(p.opts.keepRatio=["axisX","axisY","bboxCorners","bboxSides"]),p.opts.rotate===!0&&(p.opts.rotate=["axisX","axisY"]),p.opts.scale===!0&&(p.opts.scale=["axisX","axisY","bboxCorners","bboxSides"]),["drag","draw","keepRatio","rotate","scale"].map(function(t){p.opts[t]===!1&&(p.opts[t]=[])}),p.axes=[],(p.opts.rotate.indexOf("axisX")>=0||p.opts.scale.indexOf("axisX")>=0)&&p.axes.push("x"),(p.opts.rotate.indexOf("axisY")>=0||p.opts.scale.indexOf("axisY")>=0)&&p.axes.push("y"),["drag","rotate","scale"].map(function(t){p.opts.snapDist[t]||(p.opts.snapDist[t]=p.opts.snap[t])}),p.opts.range={rotate:[parseFloat(p.opts.range.rotate[0]),parseFloat(p.opts.range.rotate[1])],scale:[parseFloat(p.opts.range.scale[0]),parseFloat(p.opts.range.scale[1])]},p.opts.snap={drag:parseFloat(p.opts.snap.drag)||0,rotate:parseFloat(p.opts.snap.rotate)||0,scale:parseFloat(p.opts.snap.scale)||0},p.opts.snapDist={drag:parseFloat(p.opts.snapDist.drag)||0,rotate:parseFloat(p.opts.snapDist.rotate)||0,scale:parseFloat(p.opts.snapDist.scale)||0},"string"==typeof p.opts.size&&(p.opts.size=parseFloat(p.opts.size)||0),isNaN(p.opts.size)||(p.opts.size={axes:p.opts.size,bboxCorners:p.opts.size,bboxSides:p.opts.size,center:p.opts.size}),p.opts.customCorners&&(p.opts.customCorners.size=parseFloat(p.opts.customCorners.size)||0,p.opts.customCorners.distance=parseFloat(p.opts.customCorners.distance)||0),p.showHandles(),x(["init"]),p},p.setOpts(s,a),p.apply=function(){return p.items.map(function(t,s){var a={x:p.attrs.center.x+p.offset.translate.x,y:p.attrs.center.y+p.offset.translate.y},e=p.attrs.rotate-p.offset.rotate,r={x:p.attrs.scale.x/p.offset.scale.x,y:p.attrs.scale.y/p.offset.scale.y},o={x:p.attrs.translate.x-p.offset.translate.x,y:p.attrs.translate.y-p.offset.translate.y};p.opts.animate?(x(["animate start"]),t.el.animate({transform:["R",e,a.x,a.y,"S",r.x,r.y,a.x,a.y,"T",o.x,o.y]+p.items[s].transformString},p.opts.animate.delay,p.opts.animate.easing,function(){x(["animate end"]),p.updateHandles()})):(t.el.transform(["R",e,a.x,a.y,"S",r.x,r.y,a.x,a.y,"T",o.x,o.y]+p.items[s].transformString),x(["apply"]),p.updateHandles())}),p},p.unplug=function(){var s=p.attrs;return p.hideHandles(),delete t.freeTransform,s},e(t),p.items.map(function(t,s){t.el._&&t.el._.transform&&"object"==typeof t.el._.transform&&t.el._.transform.map(function(t){if(t[0])switch(t[0].toUpperCase()){case"T":p.items[s].attrs.translate.x+=t[1],p.items[s].attrs.translate.y+=t[2];break;case"S":p.items[s].attrs.scale.x*=t[1],p.items[s].attrs.scale.y*=t[2];break;case"R":p.items[s].attrs.rotate+=t[1]}})}),"set"!==t.type&&(p.attrs.rotate=p.items[0].attrs.rotate,p.attrs.scale=p.items[0].attrs.scale,p.attrs.translate=p.items[0].attrs.translate,p.items[0].attrs={rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},p.items[0].transformString=""),p.attrs.ratio=p.attrs.scale.x/p.attrs.scale.y,p.updateHandles(),p)}});